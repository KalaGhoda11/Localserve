<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Provider Dashboard - LocalServe</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        :root {
            --primary: #667eea;
            --secondary: #764ba2;
            --success: #28a745;
            --danger: #dc3545;
            --warning: #ffc107;
            --info: #17a2b8;
        }
        
        body { 
            background: #f8f9fa; 
            transition: background 0.3s, color 0.3s;
        }
        
        body.dark-mode {
            background: #1a1d2e;
            color: #e0e0e0;
        }
        
        body.dark-mode .card {
            background: #252945;
            color: #e0e0e0;
        }
        
        body.dark-mode .navbar {
            background: #252945 !important;
        }
        
        body.dark-mode .modal-content {
            background: #252945;
            color: #e0e0e0;
        }
        
        .stats-card { 
            border-radius: 12px; 
            transition: all 0.3s; 
            border: none;
            background: white;
        }
        
        body.dark-mode .stats-card {
            background: #2d3250;
        }
        
        .stats-card:hover { 
            transform: translateY(-5px); 
            box-shadow: 0 8px 20px rgba(0,0,0,0.15) !important; 
        }
        
        .stats-icon { 
            width: 50px; 
            height: 50px; 
            border-radius: 50%; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            color: white; 
            font-size: 1.5rem; 
        }
        
        .request-card { 
            background: white; 
            border: 2px solid #e9ecef; 
            border-radius: 12px; 
            padding: 15px; 
            margin-bottom: 15px;
            transition: all 0.3s;
        }
        
        body.dark-mode .request-card {
            background: #2d3250;
            border-color: #3d4568;
        }
        
        .job-card { 
            background: white; 
            border-left: 4px solid var(--primary); 
            border-radius: 8px; 
            padding: 15px; 
            margin-bottom: 15px; 
        }
        
        body.dark-mode .job-card {
            background: #2d3250;
        }
        
        @keyframes pulse { 
            0%, 100% { opacity: 1; } 
            50% { opacity: 0.5; } 
        }
        
        .pulse-animation { 
            animation: pulse 1.5s infinite; 
        }
        
        .chart-container {
            position: relative;
            height: 300px;
            margin: 20px 0;
        }
        
        .dark-mode-toggle {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border: none;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            cursor: pointer;
            z-index: 1000;
            transition: transform 0.3s;
        }
        
        .dark-mode-toggle:hover {
            transform: scale(1.1);
        }
        
        .toast-notification {
            position: fixed;
            top: 80px;
            right: 20px;
            min-width: 300px;
            z-index: 9999;
            animation: slideInRight 0.3s ease;
        }
        
        @keyframes slideInRight {
            from { transform: translateX(400px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .schedule-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }
        
        .day-card {
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .day-card:hover {
            border-color: var(--primary);
            background: rgba(102, 126, 234, 0.1);
        }
        
        .day-card.holiday {
            background: #ffe0e0;
            border-color: var(--danger);
        }
        
        body.dark-mode .day-card {
            border-color: #3d4568;
            background: #2d3250;
        }
        
        body.dark-mode .day-card:hover {
            background: rgba(102, 126, 234, 0.2);
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-dark bg-primary sticky-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="/"><i class="fas fa-tools"></i> LocalServe Provider</a>
            <div>
                <a href="/provider/profile" class="btn btn-outline-light btn-sm me-2">
                    <i class="fas fa-user-cog"></i> Profile Settings
                </a>
                <button class="btn btn-outline-light btn-sm" onclick="window.location.href='/'">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>
        </div>
    </nav>

    <!-- Toast Notification Container -->
    <div id="toastContainer"></div>

    <div class="container-fluid py-4">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-lg-3 mb-4">
                <div class="card shadow-sm">
                    <div class="card-body text-center">
                        <i class="fas fa-user-circle fa-5x text-primary mb-3"></i>
                        <h5 class="mb-1" id="providerName">John's Electricals</h5>
                        <p class="text-muted mb-2"><i class="fas fa-bolt"></i> <span id="providerService">Electrician</span></p>
                        <div class="mb-3">
                            <span class="text-warning">★ <span id="providerRating">4.8</span></span>
                            <small class="text-muted">(<span id="providerReviews">127</span> reviews)</small>
                        </div>
                        
                        <div class="form-check form-switch d-flex justify-content-center mb-3">
                            <input class="form-check-input me-2" type="checkbox" id="availabilitySwitch" checked onchange="toggleAvailability()">
                            <label class="form-check-label">
                                <span id="availabilityText" class="badge bg-success">Available Now</span>
                            </label>
                        </div>
                        
                        <hr>
                        
                        <div class="mb-3">
                            <h6>Quick Actions</h6>
                            <button class="btn btn-sm btn-outline-primary w-100 mb-2" onclick="showScheduleModal()">
                                <i class="fas fa-calendar"></i> Set Schedule
                            </button>
                            <button class="btn btn-sm btn-outline-info w-100" onclick="viewEarningsHistory()">
                                <i class="fas fa-chart-line"></i> View Analytics
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-9">
                <!-- Stats Cards -->
                <div class="row mb-4">
                    <div class="col-md-3 mb-3">
                        <div class="card stats-card border-0 shadow-sm">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <p class="text-muted mb-1 small">Total Jobs</p>
                                        <h3 class="mb-0" id="totalJobs">156</h3>
                                    </div>
                                    <div class="stats-icon" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                                        <i class="fas fa-clipboard-list"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="card stats-card border-0 shadow-sm">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <p class="text-muted mb-1 small">New Requests</p>
                                        <h3 class="mb-0 text-warning" id="newCount">0</h3>
                                    </div>
                                    <div class="stats-icon" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                                        <i class="fas fa-bell"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="card stats-card border-0 shadow-sm">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <p class="text-muted mb-1 small">In Progress</p>
                                        <h3 class="mb-0 text-info" id="inProgressCount">0</h3>
                                    </div>
                                    <div class="stats-icon" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                                        <i class="fas fa-spinner"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="card stats-card border-0 shadow-sm">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <p class="text-muted mb-1 small">Today Earnings</p>
                                        <h3 class="mb-0 text-success" id="earnings">₹0</h3>
                                    </div>
                                    <div class="stats-icon" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                                        <i class="fas fa-rupee-sign"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Earnings Chart -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-white">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="fas fa-chart-line text-primary"></i> Earnings Overview</h5>
                            <div class="btn-group" role="group">
                                <button type="button" class="btn btn-sm btn-outline-primary active" id="weeklyBtn" onclick="loadEarnings('weekly')">Weekly</button>
                                <button type="button" class="btn btn-sm btn-outline-primary" id="monthlyBtn" onclick="loadEarnings('monthly')">Monthly</button>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="earningsChart"></canvas>
                        </div>
                        <div class="text-center mt-3">
                            <h6 class="text-muted">Total This Period: <span class="text-success" id="totalPeriodEarnings">₹0</span></h6>
                        </div>
                    </div>
                </div>

                <!-- Tabs -->
                <ul class="nav nav-tabs mb-3">
                    <li class="nav-item">
                        <a class="nav-link active" data-bs-toggle="tab" href="#newRequests">
                            New Requests <span class="badge bg-danger" id="newBadge">0</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#activeJobs">
                            Active Jobs <span class="badge bg-info" id="activeBadge">0</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#completedJobs">Completed</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#customerFeedback">Feedback</a>
                    </li>
                </ul>

                <div class="tab-content">
                    <!-- New Requests Tab -->
                    <div class="tab-pane fade show active" id="newRequests">
                        <div class="card shadow-sm">
                            <div class="card-body" id="requestsList">
                                <div class="text-center py-4">
                                    <div class="spinner-border text-primary"></div>
                                    <p class="text-muted mt-2">Loading requests...</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Active Jobs Tab -->
                    <div class="tab-pane fade" id="activeJobs">
                        <div id="activeJobsList"></div>
                    </div>

                    <!-- Completed Jobs Tab -->
                    <div class="tab-pane fade" id="completedJobs">
                        <div id="completedJobsList"></div>
                    </div>
                    
                    <!-- Customer Feedback Tab -->
                    <div class="tab-pane fade" id="customerFeedback">
                        <div class="card shadow-sm">
                            <div class="card-body">
                                <div class="row mb-4">
                                    <div class="col-md-6">
                                        <div class="card border-0" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                                            <div class="card-body text-center">
                                                <h2 class="mb-0" id="avgRating">4.8</h2>
                                                <p class="mb-0">Average Rating</p>
                                                <div class="mt-2">★★★★★</div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="card border-0 bg-light">
                                            <div class="card-body">
                                                <h6 class="text-muted">Most Common Services</h6>
                                                <ul id="commonServices" class="list-unstyled mb-0">
                                                    <li>Installation - 45%</li>
                                                    <li>Repair - 35%</li>
                                                    <li>Products - 20%</li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <h6>Recent Reviews</h6>
                                <div id="recentReviews"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Schedule Modal -->
    <div class="modal fade" id="scheduleModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-calendar"></i> Set Your Schedule</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Start Time</label>
                            <input type="time" class="form-control" id="startTime" value="09:00">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">End Time</label>
                            <input type="time" class="form-control" id="endTime" value="18:00">
                        </div>
                    </div>
                    <h6>Mark Holidays</h6>
                    <div class="schedule-grid" id="scheduleGrid"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveSchedule()">
                        <i class="fas fa-save"></i> Save Schedule
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Chat Modal -->
    <div class="modal fade" id="chatModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-comments"></i> Chat with Customer</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="chatMessages" style="max-height: 300px; overflow-y: auto; background: #f8f9fa; border-radius: 8px; padding: 15px; margin-bottom: 15px;"></div>
                    <div class="input-group">
                        <input type="text" class="form-control" id="messageInput" placeholder="Type a message...">
                        <button class="btn btn-primary" onclick="sendMessage()"><i class="fas fa-paper-plane"></i></button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Dark Mode Toggle -->
    <button class="dark-mode-toggle" onclick="toggleDarkMode()" title="Toggle Dark Mode">
        <i class="fas fa-moon"></i>
    </button>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let requestsData = [], activeJobs = [], earningsChart, currentChatRequestId;
        let currentPeriod = 'weekly';
        const providerData = {
            id: 1,
            name: "John's Electricals",
            service: "Electrician",
            rating: 4.8,
            reviews: 127,
            phone: "+91 98765 43210",
            price: "₹500-800",
            availability: "Available Now"
        };

        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast-notification alert alert-${type} alert-dismissible fade show`;
            toast.innerHTML = `
                <strong>${type === 'success' ? '<i class="fas fa-check-circle"></i>' : '<i class="fas fa-bell"></i>'}</strong>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            container.appendChild(toast);
            
            setTimeout(() => toast.remove(), 5000);
            
            if (type === 'info') {
                playNotificationSound();
            }
        }

        function playNotificationSound() {
            const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIGGS57OmcTgwOUKnn77dlHAU7k9fyz3ksBSF0yPDhkUALEl+16OqnVRQKRp/j9L1sIgUpgc/y2ok2CQ==');
            audio.play().catch(() => {});
        }

        function toggleAvailability() {
            const toggle = document.getElementById('availabilitySwitch');
            const text = document.getElementById('availabilityText');
            
            if (toggle.checked) {
                text.textContent = 'Available Now';
                text.className = 'badge bg-success';
                providerData.availability = 'Available Now';
                startPolling();
            } else {
                text.textContent = 'Busy';
                text.className = 'badge bg-danger';
                providerData.availability = 'Currently Busy';
            }
        }

        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            localStorage.setItem('darkMode', document.body.classList.contains('dark-mode'));
            
            if (earningsChart) {
                const isDark = document.body.classList.contains('dark-mode');
                earningsChart.options.scales.y.grid.color = isDark ? '#3d4568' : '#e0e0e0';
                earningsChart.options.scales.x.grid.color = isDark ? '#3d4568' : '#e0e0e0';
                earningsChart.options.scales.y.ticks.color = isDark ? '#e0e0e0' : '#666';
                earningsChart.options.scales.x.ticks.color = isDark ? '#e0e0e0' : '#666';
                earningsChart.update();
            }
        }

        // Load dark mode preference
        if (localStorage.getItem('darkMode') === 'true') {
            document.body.classList.add('dark-mode');
        }

        function startPolling() {
            setInterval(() => {
                loadRequests();
                loadActiveJobs();
            }, 3000);
        }

        function loadRequests() {
            fetch('/api/provider/requests')
                .then(r => r.json())
                .then(data => {
                    const newRequests = data.filter(r => !requestsData.find(req => req.id === r.id));
                    if (newRequests.length > 0) {
                        newRequests.forEach(req => {
                            showToast(`New request from ${req.customer_name}`, 'info');
                        });
                    }
                    
                    requestsData = data;
                    displayRequests();
                    document.getElementById('newCount').textContent = data.length;
                    document.getElementById('newBadge').textContent = data.length;
                });
        }

        function displayRequests() {
            const list = document.getElementById('requestsList');
            if (requestsData.length === 0) {
                list.innerHTML = '<div class="text-center py-4"><i class="fas fa-inbox fa-3x text-muted mb-3"></i><p class="text-muted">No new requests</p></div>';
                return;
            }

            list.innerHTML = requestsData.map(r => `
                <div class="request-card" id="req-${r.id}">
                    <div class="d-flex justify-content-between mb-2">
                        <div>
                            <span class="badge bg-danger mb-2 pulse-animation"><i class="fas fa-bell"></i> NEW</span>
                            <h6 class="mb-1">${r.customer_name}</h6>
                            <p class="text-muted small mb-0">${r.time_ago}</p>
                        </div>
                        <span class="badge bg-primary">${r.distance}</span>
                    </div>
                    <p class="mb-1"><i class="fas fa-wrench text-primary"></i> <strong>${r.service_type}</strong></p>
                    <p class="mb-1"><i class="fas fa-money-bill-wave text-success"></i> ${r.budget}</p>
                    <p class="mb-1 text-muted small">"${r.details}"</p>
                    <p class="mb-2 text-muted small"><i class="fas fa-phone"></i> ${r.customer_phone}</p>
                    <div class="d-flex gap-2">
                        <button class="btn btn-success btn-sm flex-grow-1" onclick="acceptRequest(${r.id})">
                            <i class="fas fa-check"></i> Accept
                        </button>
                        <button class="btn btn-danger btn-sm flex-grow-1" onclick="rejectRequest(${r.id})">
                            <i class="fas fa-times"></i> Reject
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function acceptRequest(id) {
            fetch('/api/provider/accept-request', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ request_id: id, provider_data: providerData })
            })
            .then(r => r.json())
            .then(() => {
                showToast('Request accepted successfully!', 'success');
                requestsData = requestsData.filter(r => r.id !== id);
                displayRequests();
                loadActiveJobs();
            });
        }

        function rejectRequest(id) {
            fetch('/api/provider/reject-request', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ request_id: id })
            })
            .then(r => r.json())
            .then(() => {
                requestsData = requestsData.filter(r => r.id !== id);
                displayRequests();
            });
        }

        function loadActiveJobs() {
            fetch('/api/provider/requests')
                .then(r => r.json())
                .then(data => {
                    activeJobs = data.filter(j => j.status === 'accepted');
                    displayActiveJobs();
                    document.getElementById('inProgressCount').textContent = activeJobs.filter(j => j.job_status === 'in_progress').length;
                    document.getElementById('activeBadge').textContent = activeJobs.length;
                });
        }

        function displayActiveJobs() {
            const list = document.getElementById('activeJobsList');
            if (activeJobs.length === 0) {
                list.innerHTML = '<div class="alert alert-info">No active jobs</div>';
                return;
            }

            list.innerHTML = activeJobs.map(j => `
                <div class="job-card">
                    <div class="d-flex justify-content-between mb-2">
                        <div>
                            <h6 class="mb-1">${j.customer_name}</h6>
                            <p class="text-muted small mb-1">${j.service_type}</p>
                        </div>
                        <span class="badge ${j.job_status === 'in_progress' ? 'bg-primary' : 'bg-info'}">
                            ${j.job_status === 'in_progress' ? 'In Progress' : 'Accepted'}
                        </span>
                    </div>
                    <p class="mb-2"><i class="fas fa-phone"></i> ${j.customer_phone}</p>
                    <div class="d-flex gap-2">
                        ${j.job_status !== 'in_progress' ? `
                            <button class="btn btn-sm btn-primary" onclick="updateJobStatus(${j.id}, 'in_progress')">
                                <i class="fas fa-play"></i> Start Job
                            </button>
                        ` : ''}
                        ${j.job_status === 'in_progress' ? `
                            <button class="btn btn-sm btn-success" onclick="updateJobStatus(${j.id}, 'completed')">
                                <i class="fas fa-check"></i> Mark Complete
                            </button>
                        ` : ''}
                        <button class="btn btn-sm btn-outline-primary" onclick="openChat(${j.id})">
                            <i class="fas fa-comments"></i> Chat
                        </button>
                        <button class="btn btn-sm btn-outline-success" onclick="callCustomer('${j.customer_phone}')">
                            <i class="fas fa-phone"></i> Call
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function updateJobStatus(id, status) {
            fetch('/api/job/update-status', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ request_id: id, status: status })
            })
            .then(r => r.json())
            .then(() => {
                loadActiveJobs();
                if (status === 'completed') {
                    showToast('Job marked as completed! Customer will be notified to make payment.', 'success');
                }
            });
        }

        function loadEarnings(period) {
            currentPeriod = period;
            document.getElementById('weeklyBtn').classList.toggle('active', period === 'weekly');
            document.getElementById('monthlyBtn').classList.toggle('active', period === 'monthly');
            
            fetch(`/api/provider/earnings?period=${period}`)
                .then(r => r.json())
                .then(data => {
                    document.getElementById('earnings').textContent = `₹${data.total_today}`;
                    document.getElementById('totalPeriodEarnings').textContent = `₹${data.total_period}`;
                    
                    updateChart(data.data);
                });
        }

        function updateChart(data) {
            const ctx = document.getElementById('earningsChart').getContext('2d');
            const isDark = document.body.classList.contains('dark-mode');
            
            if (earningsChart) {
                earningsChart.destroy();
            }
            
            earningsChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => d.date),
                    datasets: [{
                        label: 'Earnings (₹)',
                        data: data.map(d => d.amount),
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 4,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return '₹' + context.parsed.y;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: isDark ? '#3d4568' : '#e0e0e0'
                            },
                            ticks: {
                                color: isDark ? '#e0e0e0' : '#666',
                                callback: function(value) {
                                    return '₹' + value;
                                }
                            }
                        },
                        x: {
                            grid: {
                                color: isDark ? '#3d4568' : '#e0e0e0'
                            },
                            ticks: {
                                color: isDark ? '#e0e0e0' : '#666'
                            }
                        }
                    }
                }
            });
        }

        function showScheduleModal() {
            generateScheduleGrid();
            new bootstrap.Modal(document.getElementById('scheduleModal')).show();
        }

        function generateScheduleGrid() {
            const grid = document.getElementById('scheduleGrid');
            const today = new Date();
            let html = '';
            
            for (let i = 0; i < 30; i++) {
                const date = new Date(today);
                date.setDate(date.getDate() + i);
                const dateStr = date.toISOString().split('T')[0];
                
                html += `
                    <div class="day-card" data-date="${dateStr}" onclick="toggleHoliday(this)">
                        <div><strong>${date.getDate()}</strong></div>
                        <small>${date.toLocaleDateString('en-US', { weekday: 'short' })}</small>
                    </div>
                `;
            }
            
            grid.innerHTML = html;
        }

        function toggleHoliday(element) {
            element.classList.toggle('holiday');
        }

        function saveSchedule() {
            const startTime = document.getElementById('startTime').value;
            const endTime = document.getElementById('endTime').value;
            const holidays = Array.from(document.querySelectorAll('.day-card.holiday')).map(el => el.dataset.date);
            
            fetch('/api/provider/schedule', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ start_time: startTime, end_time: endTime, holidays: holidays })
            })
            .then(r => r.json())
            .then(data => {
                showToast('Schedule updated successfully!', 'success');
                bootstrap.Modal.getInstance(document.getElementById('scheduleModal')).hide();
            });
        }

        function viewEarningsHistory() {
            document.querySelector('a[href="#completedJobs"]').click();
        }

        function openChat(requestId) {
            currentChatRequestId = requestId;
            loadMessages();
            new bootstrap.Modal(document.getElementById('chatModal')).show();
        }

        function loadMessages() {
            fetch(`/api/messages/${currentChatRequestId}`)
                .then(r => r.json())
                .then(msgs => {
                    document.getElementById('chatMessages').innerHTML = msgs.map(m => `
                        <div style="margin-bottom: 10px; padding: 8px 12px; border-radius: 8px; max-width: 70%; ${m.sender === 'provider' ? 'background: #007bff; color: white; margin-left: auto;' : 'background: #e9ecef; color: #333;'}">
                            <strong>${m.sender === 'provider' ? 'You' : 'Customer'}:</strong> ${m.message}
                            <br><small style="opacity: 0.8;">${m.timestamp}</small>
                        </div>
                    `).join('');
                });
        }

        function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            if (!message) return;

            fetch('/api/messages/send', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    request_id: currentChatRequestId,
                    sender: 'provider',
                    message: message
                })
            })
            .then(r => r.json())
            .then(() => {
                input.value = '';
                loadMessages();
            });
        }

        function callCustomer(phone) {
            window.location.href = `tel:${phone}`;
        }

        // Load provider stats
        fetch('/api/provider/stats')
            .then(r => r.json())
            .then(data => {
                document.getElementById('totalJobs').textContent = data.total_jobs;
                document.getElementById('avgRating').textContent = data.average_rating;
            });

        // Initialize
        loadRequests();
        loadActiveJobs();
        loadEarnings('weekly');
        startPolling();
    </script>
</body>
</html>